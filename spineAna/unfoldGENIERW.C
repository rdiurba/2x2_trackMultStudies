#include "TH1.h"#include "TGraph.h"#include "TEfficiency.h"#include "TH2.h"#include "TF1.h"#include "TROOT.h"#include "TStyle.h"#include "TMath.h"#include "TFile.h"#include "TCanvas.h"#include "TPad.h"#include "TGraphErrors.h"#include "TVectorD.h"#include "TTimeStamp.h"#include <fstream>#include "TMinuit.h"#include "TString.h"#include <vector>#include <string.h>#include "TLatex.h"#include "TPaveStats.h"#include "TDatime.h"#include "TColor.h"#include "TProfile.h"#include "TProfile2D.h"#include <TH2.h>#include <TStyle.h>#include <TCanvas.h>#include "TPrincipal.h"#include "TDecompChol.h"#include "TEfficiency.h"#include "RooUnfoldResponse.h"#include "RooUnfoldBayes.h"#include <iomanip>void unfoldGENIERW(){gROOT->LoadMacro("protoDUNEStyle.C");gROOT->SetStyle("protoDUNEStyle");gROOT->ForceStyle();gStyle->SetTitleX(0.35);gStyle->SetOptFit(111);float NAr=2.824206e+28;  int binsMult=7;  Double_t edgesMult[8]={1,2,3,4,5,6,8,10};  Double_t edges[7] = {0.91, 0.96, 0.98, 0.9887, 0.994, 0.9974, 1};TCanvas c1=TCanvas();TLatex tL;    tL.SetNDC();    tL.DrawLatex(0.20,0.94,"#bf{DUNE:ND-LAr 2x2}");TFile fPurity("testGENIERWSPINE.root");TFile fFakeData("testSPINEPart2.root");TFile fCV("simFakeDataSPINE.root");TH1D* unfoldCosL=(TH1D*)fCV.Get("unfoldCosL");TH1D* unfoldMult=(TH1D*)fCV.Get("unfoldMult");TH1D* totalPOT=(TH1D*)fPurity.Get("totalPOT");totalPOT->SetName("totalPOTMC");TH1D* totalPOTFakeData=(TH1D*)fFakeData.Get("totalPOT");double ratio=1.3E6/totalPOTFakeData->Integral();double ratioMC=1.3E6/totalPOT->Integral();    int totBins=6;TProfile* unfoldCosLProfile=new TProfile("unfoldCosLProfile","unfoldCosLProfile",totBins,edges,"S");TProfile* unfoldMultProfile=new TProfile("unfoldMultProfile","unfoldMultProfile",binsMult, edgesMult,"S");unfoldCosL->Scale(1.f/ratio);unfoldMult->Scale(1.f/ratio);TH2D* covMatMult=new TH2D("covMatMult","covMatMult",binsMult, edgesMult , binsMult, edgesMult );TH2D* covMatCosL=new TH2D("covMatCosL","covMatCosL",totBins, edges , totBins, edges );    int totToys=100;    std::vector<std::vector<double>> unfoldMultVecVec;std::vector<std::vector<double>> unfoldCosLVecVec;std::vector<TH1D> unfoldMultVecHist;std::vector<TH1D> unfoldCosLVecHist;TH1D* selCosL=(TH1D*)fFakeData.Get("recoCosL");    TH1D* selMult=(TH1D*)fFakeData.Get("track_mult");TH1D* simCosL=(TH1D*)fPurity.Get("recoCosL");simCosL->SetName("simCosL"); std::cout<<simCosL->GetTitle()<<std::endl;double flux_nominal=stod(simCosL->GetTitle());unfoldCosL->Scale(ratio/(flux_nominal*1.3E19));unfoldMult->Scale(ratio/(flux_nominal*1.3E19));TH1D* trueMult2=new TH1D("trueMult2","trueMult2",binsMult,edgesMult);TH1D* recoMult2=new TH1D("recoMult2","recoMult2",binsMult,edgesMult);TH1D* trueCosL2=new TH1D("trueCosL2","trueCosL2",6,edges);TH1D* recoCosL2=new TH1D("recoCosL2","recoCosL2",6,edges);for (Int_t k=0; k<totToys; k++){RooUnfoldResponse responses(trueCosL2, recoCosL2);responses.UseOverflow();RooUnfoldResponse responsesMults(trueMult2, recoMult2);responsesMults.UseOverflow();TH2D* response=(TH2D*)fPurity.Get(Form("responseCosL_%d",k));TH1D* truthCosL=(TH1D*)fPurity.Get(Form("trueCosL_%d",k));TH1D* missRecoCosL=(TH1D*)truthCosL->Clone(Form("missRecoCosL_%d",k));TH1D* backtrackCosL=(TH1D*)fPurity.Get(Form("backtrackTrueCosL_%d",k));TH1D* trueMatchMultTrkOnly =(TH1D*)fPurity.Get(Form("backtrackTrueMult_%d",k));    TH1D* badRecoCosL=(TH1D*)fPurity.Get(Form("badRecoCosL_%d",k));std::cout<<badRecoCosL->GetEntries()<<","<<backtrackCosL->GetEntries()<<","<<truthCosL->GetEntries()<<std::endl;missRecoCosL->Add(backtrackCosL,-1);std::cout<<"Efficiency: "<<(truthCosL->GetEntries()-missRecoCosL->GetEntries())/truthCosL->GetEntries()<<std::endl;std::cout<<"Purity: "<<(simCosL->GetEntries()-badRecoCosL->GetEntries())/simCosL->GetEntries()<<std::endl;   for (int i=-1; i<totBins; i++){    std::cout<<badRecoCosL->GetBinContent(i+1)<<","<<missRecoCosL->GetBinContent(i+1)<<std::endl;       responses.Fake(badRecoCosL->GetBinCenter(i+1),badRecoCosL->GetBinContent(i+1));   responses.Miss(missRecoCosL->GetBinCenter(i+1),missRecoCosL->GetBinContent(i+1));        for (int j=-1; j<totBins; j++){        responses.Fill(response->GetXaxis()->GetBinCenter(i+1),response->GetYaxis()->GetBinCenter(j+1), response->GetBinContent(i+1,j+1));      }}    RooUnfoldBayes unfoldDataCosL(&responses, selCosL,4);TH1D* trackMultBad=(TH1D*)fPurity.Get(Form("badRecoMult_%d",k));TH1D* simMult=(TH1D*)fPurity.Get(Form("recoMult_%d",k));simMult->SetName("sim_mult");TH1D* truthMult=(TH1D*)fPurity.Get(Form("true_mult_%d",k));selMult->SetLineColor(kRed); selMult->SetMarkerColor(kRed);    truthMult->SetLineColor(kBlue); truthMult->SetMarkerColor(kBlue);          TLegend *lVertex2 = new TLegend(0.2,0.7,0.8,0.85);  lVertex2->SetTextFont(133);  lVertex2->SetTextSize(25);  lVertex2->SetHeader(Form("RHC %1.2fE19 POT",totalPOTFakeData->GetBinContent(1)*ratio/1E6));  lVertex2->AddEntry(selMult,"Simulated Selected Interactions","lp");  lVertex2->AddEntry(truthMult,"Truth-Level Information","lp");          TLegend *lVertex3 = new TLegend(0.4,0.7,0.8,0.85);  lVertex3->SetTextFont(133);  lVertex3->SetTextSize(25);  lVertex3->SetHeader(Form("RHC %1.2fE19 POT",totalPOTFakeData->GetBinContent(1)*ratio/1E6));  lVertex3->AddEntry(truthMult,"True CC Interactions","lp");TH1D* missRecoMult=(TH1D*)truthMult->Clone(Form("missRecoMult_%d",k));std::cout<<trackMultBad->GetEntries()<<std::endl;missRecoMult->Add(trueMatchMultTrkOnly,-1);TH2D* responseMult=(TH2D*)fPurity.Get(Form("responseMult_%d",k));   for (int i=-1; i<binsMult+1; i++){  responsesMults.Fake(trackMultBad->GetBinCenter(i+1),trackMultBad->GetBinContent(i+1));   responsesMults.Miss(missRecoMult->GetBinCenter(i+1),missRecoMult->GetBinContent(i+1));        for (int j=-1; j<binsMult+1; j++){        responsesMults.Fill(responseMult->GetXaxis()->GetBinCenter(i+1),responseMult->GetYaxis()->GetBinCenter(j+1), responseMult->GetBinContent(i+1,j+1));      }}RooUnfoldBayes unfoldDataMult(&responsesMults, selMult,4);TH1D* recoDataCosLCopy=(TH1D*) unfoldDataCosL.Hreco();TH1D* recoDataMultCopy=(TH1D*) unfoldDataMult.Hreco(); 	std::vector<double> tmpVecMult;std::vector<double> tmpVecCosL;recoDataCosLCopy->Scale(1.f/(NAr*flux_nominal*totalPOTFakeData->GetBinContent(1)*1E13));recoDataMultCopy->Scale(1.f/(NAr*flux_nominal*totalPOTFakeData->GetBinContent(1)*1E13));      for (int i = 1; i <=selCosL->GetNbinsX(); ++i) {        recoDataCosLCopy->SetBinContent(i,recoDataCosLCopy->GetBinContent(i)/recoDataCosLCopy->GetBinWidth(i));                recoDataCosLCopy->SetBinError(i,recoDataCosLCopy->GetBinError(i)/recoDataCosLCopy->GetBinWidth(i));      }      for (int i = 1; i <=selMult->GetNbinsX(); ++i) {        recoDataMultCopy->SetBinContent(i,recoDataMultCopy->GetBinContent(i)/recoDataMultCopy->GetBinWidth(i));                recoDataMultCopy->SetBinError(i,recoDataMultCopy->GetBinError(i)/recoDataMultCopy->GetBinWidth(i));      }      for (int i = 1; i <=selCosL->GetNbinsX(); ++i) {        tmpVecCosL.push_back(recoDataCosLCopy->GetBinContent(i));       unfoldCosLProfile->Fill(selCosL->GetBinCenter(i),recoDataCosLCopy->GetBinContent(i));       std::cout<<recoDataCosLCopy->GetBinContent(i+1)<<std::endl;      }      for (int i = 1; i <=selMult->GetNbinsX(); ++i) {               unfoldMultProfile->Fill(selMult->GetBinCenter(i),recoDataMultCopy->GetBinContent(i));            tmpVecMult.push_back(recoDataMultCopy->GetBinContent(i));      }TH1D* tempHistMult=(TH1D*)recoDataMultCopy->Clone(Form("toyMult_%d",k));TH1D* tempHistCosL=(TH1D*)recoDataCosLCopy->Clone(Form("toyCosL_%d",k));unfoldMultVecHist.push_back(*tempHistMult);unfoldCosLVecHist.push_back(*tempHistCosL);unfoldMultVecVec.push_back(tmpVecMult);unfoldCosLVecVec.push_back(tmpVecCosL);std::cout<<"On Toy:"<<k<<std::endl;}for(long unsigned int toy=0; toy<unfoldMultVecVec.size(); toy++){    auto multVec=unfoldMultVecVec.at(toy);    auto cosLVec=unfoldCosLVecVec.at(toy);    TH1D tmpHistMult=unfoldMultVecHist.at(toy);    TH1D tmpHistCosL=unfoldCosLVecHist.at(toy); //   std::cout<<dataVec.at(4)<<','<<dataVec.at(5)<<std::endl;    //std::cout<<tmpHist->GetBinContent(5)<<std::endl;  for (Int_t bin=0; bin<selCosL->GetXaxis()->GetNbins(); ++bin){    for (Int_t bin2=0; bin2<selCosL->GetXaxis()->GetNbins(); ++bin2){    int binNum=(bin)*totBins+(bin2);    double diffBin1MC=tmpHistCosL.GetBinContent(bin+1)-unfoldCosLProfile->GetBinContent(bin+1);    double diffBin2MC=tmpHistCosL.GetBinContent(bin2+1)-unfoldCosLProfile->GetBinContent(bin2+1);    covMatCosL->SetBinContent(bin+1,bin2+1,covMatCosL->GetBinContent(bin+1,bin2+1)+((diffBin1MC*diffBin2MC)/(unfoldMultVecVec.size()-1)));    }}   for (Int_t bin=0; bin<selMult->GetXaxis()->GetNbins(); ++bin){    for (Int_t bin2=0; bin2<selMult->GetXaxis()->GetNbins(); ++bin2){    int binNum=(bin)*totBins+(bin2);           double diffBin1=tmpHistMult.GetBinContent(bin+1)- unfoldMultProfile->GetBinContent(bin+1);    double diffBin2=tmpHistMult.GetBinContent(bin2+1)- unfoldMultProfile->GetBinContent(bin2+1);    covMatMult->SetBinContent(bin+1,bin2+1,covMatMult->GetBinContent(bin+1,bin2+1)+((diffBin1*diffBin2)/(unfoldMultVecVec.size()-1)));  }  }}   TMatrixD erecoCosL(selCosL->GetXaxis()->GetNbins(),selCosL->GetXaxis()->GetNbins());   TMatrixD erecoMult(selMult->GetXaxis()->GetNbins(),selMult->GetXaxis()->GetNbins());   for (int i = 0; i < selCosL->GetXaxis()->GetNbins(); ++i) {    for (int j = 0; j < selCosL->GetXaxis()->GetNbins(); ++j) {    erecoCosL[i][j] = covMatCosL->GetBinContent(i+1, j+1);  }}    for (int i = 0; i < selMult->GetXaxis()->GetNbins(); ++i) {    for (int j = 0; j <  selMult->GetXaxis()->GetNbins(); ++j) {    erecoMult[i][j] = covMatMult->GetBinContent(i+1, j+1);  }}        std::cout << "Relative Uncert. for 100 GENIE Univ. \n";    std::cout << "Bin, CosL Frac. Uncert., Mult. Frac. Uncert. \n";    std::cout << "---------------------------------------------\n";    for (int i = 0; i < selMult->GetXaxis()->GetNbins(); ++i) {  std::cout<<i+1<<" , "<<TMath::Sqrt(covMatCosL->GetBinContent(i+1,i+1))/unfoldCosLProfile->GetBinContent(i+1)<<" , "<<TMath::Sqrt(covMatMult->GetBinContent(i+1,i+1))/unfoldMultProfile->GetBinContent(i+1)<<std::endl;      }    covMatCosL->SetName("covMatCosLGENIE"); covMatCosL->SetTitle("covMatCosLGENIE"); covMatMult->SetName("covMatMultGENIE"); covMatMult->SetTitle("covMatMultGENIE");    TFile output("output.root","UPDATE"); covMatCosL->Write(); covMatMult->Write(); output.Write(); output.Close();    }